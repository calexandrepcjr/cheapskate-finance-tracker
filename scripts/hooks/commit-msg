#!/bin/bash
#
# Git commit-msg hook for Cheapskate Finance Tracker
# Enforces conventional commits format
#
# Conventional Commits Format:
#   <type>[optional scope]: <description>
#   [optional body]
#   [optional footer(s)]
#
# Allowed types:
#   feat     - A new feature
#   fix      - A bug fix
#   docs     - Documentation only changes
#   style    - Changes that don't affect code meaning (formatting, whitespace)
#   refactor - Code change that neither fixes a bug nor adds a feature
#   perf     - Code change that improves performance
#   test     - Adding missing tests or correcting existing tests
#   build    - Changes that affect the build system or dependencies
#   ci       - Changes to CI configuration files and scripts
#   chore    - Other changes that don't modify src or test files
#   revert   - Reverts a previous commit
#
# To install: ./scripts/setup-hooks.sh
#

set -e

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# Skip revert commits (generated by git revert)
if echo "$COMMIT_MSG" | grep -qE "^Revert \""; then
    exit 0
fi

# Conventional commit regex pattern
# Matches: type(scope): description or type: description
# Type must be lowercase, scope is optional
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9_-]+\))?: .+"

# Get first line of commit message
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo ""
    echo "=========================================="
    echo "COMMIT REJECTED: Invalid commit message format!"
    echo "=========================================="
    echo ""
    echo "Your commit message:"
    echo "  \"$FIRST_LINE\""
    echo ""
    echo "Conventional Commits format required:"
    echo "  <type>[optional scope]: <description>"
    echo ""
    echo "Allowed types:"
    echo "  feat     - A new feature"
    echo "  fix      - A bug fix"
    echo "  docs     - Documentation only changes"
    echo "  style    - Formatting, whitespace (no code change)"
    echo "  refactor - Code change (no feature or fix)"
    echo "  perf     - Performance improvement"
    echo "  test     - Adding or correcting tests"
    echo "  build    - Build system or dependencies"
    echo "  ci       - CI configuration changes"
    echo "  chore    - Other maintenance tasks"
    echo "  revert   - Reverts a previous commit"
    echo ""
    echo "Examples:"
    echo "  feat: add transaction export feature"
    echo "  fix(parser): handle negative amounts correctly"
    echo "  docs: update README with installation steps"
    echo "  test(handlers): add dashboard endpoint tests"
    echo ""
    exit 1
fi

echo "Commit message format validated: conventional commit âœ“"
